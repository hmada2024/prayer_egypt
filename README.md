# شرح كود إنشاء قاعدة بيانات المدن العربية المحسنة

يهدف هذا الكود إلى إنشاء قاعدة بيانات SQLite شاملة تحتوي على معلومات تفصيلية حول المدن والبلدات والقرى في الدول العربية. يتم استخلاص البيانات من ملف OpenStreetMap (OSM) وتتضمن معلومات مثل الأسماء باللغة العربية والإنجليزية، والإحداثيات الجغرافية، والمناطق الزمنية، والتقسيمات الإدارية.

## المميزات الرئيسية:

*   **تغطية واسعة للمواقع:** لا يقتصر على المدن الرئيسية فقط، بل يشمل البلدات والقرى والتجمعات السكنية الصغيرة.
*   **معلومات إدارية مفصلة:** يتضمن اسم الدولة (من OSM وباللغة العربية) واسم المحافظة أو الولاية باللغة العربية (إذا كانت متاحة في بيانات OSM).
*   **دعم الأسماء المتعددة:** يحتفظ بالاسم الأصلي للموقع (عادةً بالإنجليزية) كاسم بديل إذا كان الاسم الأساسي باللغة العربية.
*   **تحديد المنطقة الزمنية:** يضيف معلومات حول المنطقة الزمنية لكل موقع لتمكين حسابات دقيقة لمواقيت الصلاة والشروق والغروب.
*   **شريط التقدم:** يعرض شريط تقدم مرئي في терминал أثناء معالجة البيانات لإظهار مدى اكتمال العملية.
*   **تسجيل الأخطاء والعمليات:** يستخدم نظام تسجيل (`logging`) لتتبع العمليات التي تتم والأخطاء التي قد تحدث، مما يسهل عملية التصحيح.
*   **كفاءة في التعامل مع البيانات:** يقوم بتجميع البيانات قبل حفظها في قاعدة البيانات لزيادة الكفاءة.
*   **مرونة في استخلاص التقسيمات الإدارية:** يستخدم دالة مساعدة ذكية لاستخلاص أسماء التقسيمات الإدارية من علامات مختلفة في بيانات OSM.

## المكتبات المستخدمة ودورها:

*   **`geopandas`:**
    *   **الدور:** قراءة ومعالجة البيانات الجغرافية المكانية من ملف OpenStreetMap (بصيغة PBF). يوفر هياكل بيانات وأدوات للتعامل مع البيانات الجغرافية مثل النقاط والخطوط والمضلعات.
*   **`sqlalchemy`:**
    *   **الدور:** مكتبة قوية للتعامل مع قواعد البيانات العلائقية. في هذا الكود، تُستخدم لإنشاء محرك اتصال بقاعدة بيانات SQLite وتنفيذ أوامر SQL لإنشاء الجدول وإضافة البيانات.
    *   **الميزة:** يوفر طريقة أكثر مرونة وقوة للتعامل مع قواعد البيانات مقارنة بوحدة `sqlite3` المدمجة في بايثون.
*   **`timezonefinder`:**
    *   **الدور:** تحديد المنطقة الزمنية التي يقع فيها موقع معين بناءً على خط الطول والعرض.
    *   **الميزة:** يسمح بإضافة معلومات المنطقة الزمنية تلقائيًا لكل مدينة.
*   **`logging`:**
    *   **الدور:** تسجيل الأحداث التي تقع أثناء تشغيل الكود، مثل معلومات حول قراءة البيانات، وحفظها، وأي أخطاء أو تحذيرات تظهر.
    *   **الميزة:** يساعد في تتبع سير عمل الكود وتشخيص المشاكل.
*   **`pycountry`:**
    *   **الدور:** توفير معلومات حول الدول، مثل تحويل رمز الدولة المكون من حرفين (مثل "EG") إلى اسم الدولة الكامل (مثل "Egypt").
    *   **الميزة:** يستخدم للتحقق من أن المواقع المستخرجة تقع ضمن قائمة الدول العربية المستهدفة.
*   **`pandas`:**
    *   **الدور:** توفير هياكل بيانات عالية الأداء (مثل DataFrame) وأدوات لتحليل البيانات.
    *   **الميزة:** يستخدم هنا لتحويل قائمة بيانات المدن إلى DataFrame وحفظها بكفاءة في قاعدة البيانات مرة واحدة.
*   **`tqdm`:**
    *   **الدور:** إضافة شريط تقدم مرئي في терминал لتتبع مدى اكتمال العمليات التي تستغرق وقتًا طويلاً.
    *   **الميزة:** يوفر مؤشرًا مرئيًا لتقدم المعالجة، مما يحسن تجربة المستخدم أثناء تشغيل الكود.

## ما يفعله الكود بالتفصيل:

1. **استيراد المكتبات:** يتم استيراد جميع المكتبات الضرورية للتعامل مع البيانات الجغرافية، وقواعد البيانات، والمناطق الزمنية، وتسجيل الأحداث، وعرض شريط التقدم.
2. **إعداد التسجيل:** يتم تكوين نظام التسجيل لتسجيل المعلومات والأخطاء في терминал.
3. **تحديد المصادر والمتغيرات:** يتم تحديد اسم ملف OSM، واسم قاعدة البيانات، وقائمة الدول العربية المستهدفة.
4. **تهيئة TimezoneFinder:** يتم إنشاء نسخة من كائن `TimezoneFinder` لتحديد المناطق الزمنية.
5. **دالة مساعدة للتقسيمات الإدارية:** يتم تعريف دالة `get_admin_name` لاستخراج أسماء التقسيمات الإدارية بمرونة من بيانات OSM.
6. **إنشاء محرك قاعدة البيانات:** يتم إنشاء محرك اتصال بقاعدة بيانات SQLite باستخدام `sqlalchemy`.
7. **إنشاء جدول قاعدة البيانات:** يتم إنشاء جدول باسم `cities` في قاعدة البيانات، مع تحديد الأعمدة اللازمة لتخزين معلومات المدن (الاسم بالعربي، الإحداثيات، المنطقة الزمنية، الدولة، المحافظة، الأسماء البديلة).
8. **قراءة بيانات OSM:** يتم قراءة البيانات الجغرافية من ملف OSM باستخدام `geopandas`.
9. **استخلاص ومعالجة المدن العربية:**
    *   يتم تكرار جميع العناصر في بيانات OSM مع عرض شريط تقدم باستخدام `tqdm`.
    *   يتم التحقق مما إذا كان العنصر مصنفًا كمدينة أو بلدة أو قرية أو تجمع سكني صغير.
    *   يتم استخراج رمز الدولة، ثم يتم استخدام `pycountry` للحصول على اسم الدولة باللغة الإنجليزية.
    *   يتم التحقق مما إذا كانت الدولة ضمن قائمة الدول العربية المستهدفة.
    *   يتم استخراج اسم المدينة (باللغة العربية إن وجد، وإلا يتم استخدام الاسم الافتراضي).
    *   يتم الحصول على الإحداثيات الجغرافية.
    *   يتم تحديد المنطقة الزمنية باستخدام `timezonefinder`.
    *   يتم استخلاص اسم الدولة والمحافظة باللغة العربية باستخدام الدالة المساعدة.
    *   يتم تجميع بيانات كل مدينة في قاموس.
10. **حفظ البيانات في قاعدة البيانات:**
    *   يتم تحويل قائمة بيانات المدن إلى DataFrame باستخدام `pandas`.
    *   يتم حفظ DataFrame في جدول `cities` في قاعدة بيانات SQLite بكفاءة.
11. **إظهار رسالة النجاح:** يتم طباعة رسالة تفيد بنجاح إنشاء قاعدة البيانات.

باختصار، هذا الكود عبارة عن أداة قوية لإنشاء قاعدة بيانات جغرافية غنية بالمعلومات حول المدن والبلدات في العالم العربي، مع التركيز على توفير بيانات دقيقة ومفصلة لتلبية احتياجات تطبيقات مثل تطبيقات مواقيت الصلاة، بالإضافة إلى توفير تجربة مستخدم أفضل من خلال عرض شريط التقدم.